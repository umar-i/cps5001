flowchart TB
    classDef ext fill:#fdf6e3,stroke:#586e75,stroke-dasharray: 5 5

    User["User / Assessor"]:::ext
    Inputs["CSV Inputs\n(data/scenarios/*.csv)"]:::ext
    Outputs["CSV Metrics + Tables\n(data/out/*, docs/results/*)"]:::ext

    subgraph L1["Presentation Layer"]
        CLI["CLI: Main\nCommands: demo | scenario | evaluate"]
    end

    subgraph L2["Application Layer (Orchestration)"]
        Loader["CSV Loaders\n(CsvGraphLoader, CsvScenarioLoader)"]
        Engine["SimulationEngine\n(PriorityQueue<TimedEvent>)"]
        Controller["PerdsController\n(SystemCommandExecutor)"]
    end

    subgraph L3["Domain Layer (Decision Logic)"]
        Dispatch["Dispatch\n(DefaultDispatchEngine + Policies)"]
        Routing["Routing\n(DijkstraRouter / AStarRouter)"]
        Prediction["Prediction + Pre-positioning\n(DemandPredictor + PrepositioningStrategy)"]
    end

    subgraph L4["Core Model + Data Structures"]
        Model["Domain Model\n(Incident, ResponseUnit, Assignment, IDs)"]
        Graph["Dynamic Graph\n(AdjacencyMapGraph)"]
        Heap["Indexed Heap\n(BinaryHeapIndexedMinPriorityQueue)"]
        RouteIndex["AssignmentRouteIndex\n(edge -> affected assignments)"]
        Metrics["Metrics\n(InMemoryMetricsCollector, CsvMetricsExporter)"]
    end

    User --> CLI
    Inputs --> Loader
    Loader --> CLI

    CLI --> Engine
    Engine --> Controller

    Controller --> Dispatch
    Controller --> Prediction
    Dispatch --> Routing
    Prediction --> Routing

    Controller --> Graph
    Routing --> Graph
    Routing --> Heap

    Controller --> Model
    Dispatch --> Model
    Prediction --> Model
    Controller --> RouteIndex

    Controller --> Metrics
    Metrics --> Outputs
